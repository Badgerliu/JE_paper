---
title: "Figure_2_plots"
author: "Huan Liu"
date: "2024-07-03"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(
  tidy = TRUE,
  eval = FALSE,
  tidy.opts = list(width.cutoff = 120),
  message = TRUE,
  warning = FALSE,
  cache = TRUE,
  label.duplicate = "append"
)

```

# 1 Load packages and datasets

```{r,load of packages and setup of the environment 1}
gc()
rm(list=ls())
library(Seurat)
library(data.table)
library(scales)
library(plotly)
library(ggplot2)
library(slingshot)
library(magrittr)
library(dplyr)
library(tidyverse)
library(cowplot)
library(gridExtra)
library(viridis)
library(readr)
library(Hmisc)
library(ggpubr)
library(rsample)
library(tidymodels)
library(scales)
library(tradeSeq)
library(pheatmap)
library(scCustomize)
library(destiny)
library(plot3D)
library(rgl)
library(RColorBrewer)

source("./diffprop_functions.R")

set.seed(12)
theme_set(theme_bw())

load(file = "./Figure2_scRNA_part/Figure2_scRNA_part.Rdata")
#JE_K5 <- readRDS(file = "./SeuratObject/JE_K5_harmony_celltype_20240708.rds")
#sce <-readRDS(file = "./SeuratObject/JE_combined_epi_harmony_SCT_renamed_slingshot.rds")
#JE_combined <- readRDS(file = "./SeuratObject/JE_combined_harmony_20221128.rds")
#JE_combined_epi <-readRDS(file = "./SeuratObject/JE_combined_epi_harmony_MAGIC_renamed.rds")

#JE_K5_epi <- readRDS(file = "./SeuratObject/JE_K5_epi_MAGIC_harmony_renamed.rds")
#JE_K5_MAGIC <- readRDS(file = "./SeuratObject/JE_K5_harmony_MAGIC_20240710.rds")


```


#2 Krt14 and Krt5 smooth plot

```{r}
curvesCols <- c("#619CFF", "transparent","#00BA38","transparent")
plotSmoothers(sce.trade, counts, "Krt14", curvesCols = curvesCols,size=1/10,
              border = FALSE) +  xlim(0,15) +ylim(0,6)+
  scale_color_manual(values = curvesCols)
ggsave("./Figure2_scRNA_part/Plot_Krt14_lineage1vs3.pdf",  width = 15, height = 5)
```

```{r}
curvesCols <- c("#619CFF", "transparent","#00BA38","transparent")
plotSmoothers(sce.trade, counts, "Krt5", curvesCols = curvesCols,size=1/10,
              border = FALSE) + xlim(0,15) +ylim(0,6)+
  scale_color_manual(values = curvesCols)
ggsave("./Figure2_scRNA_part/Plot_Krt5_lineage1vs3.pdf",  width = 15, height = 5)
```
#3 Summary of JE_K5

## 3.1 UMAP for celltype
```{r, initial plots}
Idents(JE_K5_MAGIC) <- JE_K5_MAGIC$celltype
#group_by_cluster
plot1 = DimPlot(JE_K5_MAGIC, reduction = "umap", pt.size=0.01, label = T, repel=T)
# group_by_sample
plot2 = DimPlot(JE_K5_MAGIC, reduction = "umap", pt.size=0.01, group.by = "orig.ident")
plot3 = DimPlot(JE_K5_MAGIC, reduction = "umap", pt.size=0.01, label = T, split.by  = "orig.ident")
# combine
plotc <- plot1 + plot2
ggsave("./Figure2_scRNA_part/JE_K5_MAGIC_umap.pdf", plot = plotc, width = 20, height = 10)
plot3
ggsave("./Figure2_scRNA_part/JE_K5_MAGIC_umap_split.pdf", plot = plot3, width = 24, height = 10)

DimPlot(JE_K5_MAGIC, reduction = "umap", pt.size=0.01, label = T)
DimPlot(JE_K5_MAGIC, reduction = "umap", pt.size=0.01, label = T,group.by = "orig.ident")

```
## 3.2 Dotplot for marker genes in JE_1st
```{r, setup gene list}
#markers refer to https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7359078/ and marker genes in each cluster
genes_to_check <- c("Col1a1", "Postn","Nfia", #Dermal
                    "Epcam","Krt14","Krt24","Krt5","Mki67","Krtdap","Atf3",  #Epithelium
                    "Ccl3","Cxcl2", #Macrophage
                    "Lyz2","Cd74", #Monocyte
                    "Plvap","Egfl7",#Endothelial cell
                    "Icos","Cxcr6", #T cell
                    "Mpz","Plp1", #Glial cell
                    "Rgs5","Myh11", #Pericyte,
                    "Ccl21a","Mmrn1", #Lymphatic endothelial cell
                    "Hbb-bt","Hba-a1", #Erythroid cell
                    "Cd79a","Cd79b" #B cell
                             )
```

```{r,dotplot for marker genes}

# Define the desired order for celltype
desired_order <- c("Fibroblast","Basal","Cycling","Intermidate","Keratinocyte","JE","Macrophage","Monocyte",
                   "Endothelial cell","T Cell", "Glial cell","Pericyte","Lymphatic Vessel","B cell")
desired_order <- rev(desired_order)

# Set the identities in the Seurat object to celltype
JE_K5$celltype <- factor(JE_K5$celltype, levels = desired_order)
Idents(JE_K5) <- JE_K5$celltype

# Generate the dot plot
DotPlot(JE_K5, features = unique(genes_to_check)) +
  theme_bw() +
  theme(panel.grid = element_blank(), 
        axis.text.x = element_text(angle = 45, hjust = 0.5, vjust = 0.5),
        panel.border = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_blank()) +
  labs(x = NULL, y = NULL) + 
  guides(size = guide_legend(order = 3)) +
  scale_color_gradientn(values = seq(0, 1, 0.2), colours = c('#295B9F', '#FFFFFF', '#D23B3E'))

# Save the dot plot
ggsave("./Figure2_scRNA_part/JE_K5_harmony_dotplot_feature.pdf", width = 8.5, height = 5)
```


## 3.3 Celltype percentage display
```{r}
# Load necessary libraries
library(Seurat)
library(data.table)
library(ggplot2)
library(reshape2)
library(dplyr)

# Extract meta data
md <- JE_K5_MAGIC@meta.data %>% as.data.table
md  # The resulting md object has one "row" per cell

# Count the number of cells per unique combinations of "orig.ident" and "celltype"
cell_counts <- md[, .N, by = c("orig.ident", "celltype")]

# Cast the data from long to wide format
split_count <- dcast(cell_counts, orig.ident ~ celltype, value.var = "N", fill = 0)

# Melt the data back to long format for ggplot2
split_count_melt <- melt(split_count, id.vars = "orig.ident", variable.name = "celltype", value.name = "Number")

# Save the cell count data to a CSV file
write.csv(split_count_melt, file = "./Figure2_scRNA_part/JE_K5_MAGIC_harmony_cell_number_celltype.csv", row.names = FALSE)

# Define the desired order for celltype
desired_order <- c("Fibroblast","Basal","Cycling","Intermidate","Keratinocyte","JE","Macrophage","Monocyte",
                   "Endothelial cell","T Cell", "Glial cell","Pericyte","Lymphatic Vessel","B cell")


# Convert celltype to factor with the desired order
split_count_melt$celltype <- factor(split_count_melt$celltype, levels = desired_order)

# Generate a stacked bar plot with a white theme and black border for unnormalized data
ggplot(split_count_melt, aes(fill = orig.ident, x = celltype, y = Number)) +
  geom_bar(position = "fill", stat = "identity") +
  ggtitle("Percentage of cells in each cluster") +
  xlab("celltype") +
  ylab("Percentage of cells") +
  theme_classic() +
  theme(plot.title = element_text(hjust = 0.5),axis.text.x = element_text(angle = 45, hjust = 0.5, vjust = 0.5),
        panel.border = element_rect(color = "black", fill = NA, size = 0.5))

ggsave("./Figure2_scRNA_part/JE_K5_MAGIC_harmony_Percentage_cell_in_each_celltype_unnormalized.pdf", height = 3, width = 7.5)

# Normalize cell counts to the total number in each sample
split_count$total <- rowSums(split_count[, -1])

# Calculate the percentage for each cluster
split_count_percent <- split_count %>%
  mutate(across(-c(orig.ident, total), ~ . / total * 100, .names = "{.col}_percent"))

# Reshape data for ggplot2
split_count_percent_melt <- melt(split_count_percent, id.vars = "orig.ident", 
                                 variable.name = "celltype", 
                                 value.name = "Percentage",
                                 measure.vars = grep("_percent$", names(split_count_percent), value = TRUE))

# Remove "_percent" from celltype
split_count_percent_melt$celltype <- gsub("_percent", "", split_count_percent_melt$celltype)

# Filter out rows with NA in celltype
split_count_percent_melt <- split_count_percent_melt[!is.na(split_count_percent_melt$celltype), ]

# Convert celltype to factor with the desired order
split_count_percent_melt$celltype <- factor(split_count_percent_melt$celltype, levels = desired_order)

# Save the percentage data to a CSV file
write.csv(split_count_percent_melt, file = "./Figure2_scRNA_part/JE_K5_MAGIC_harmony_cell_percentage_celltype.csv", row.names = FALSE)

# Generate a stacked bar plot with a white theme and black border for normalized data
ggplot(split_count_percent_melt, aes(fill = orig.ident, x = celltype, y = Percentage)) +
  geom_bar(position = "fill", stat = "identity") +
  ggtitle("Percentage of cells in each celltype") +
  xlab("celltype") +
  ylab("Percentage of cells") +
  theme_classic() +
  theme(plot.title = element_text(hjust = 0.5),axis.text.x = element_text(angle = 45, hjust = 0.5, vjust = 0.5),
        panel.border = element_rect(color = "black", fill = NA, size = 1))

ggsave("./Figure2_scRNA_part/JE_K5_MAGIC_harmony_Percentage_cell_in_each_celltype_normalized.pdf", height = 3, width = 7.5)

# Generate a stacked bar plot for percentage of cells (alternative layout)
ggplot(split_count_percent_melt, aes(x = celltype, y = Percentage)) +
  geom_col(aes(fill = orig.ident), color = "black") + 
  theme_bw() + 
  theme(panel.grid = element_blank(),axis.text.x = element_text(angle = 45, hjust = 0.5, vjust = 0.5))
ggsave("./Figure2_scRNA_part/JE_K5_MAGIC_harmony_Percentage_cell_in_each_celltype_normalized_stack.pdf", height = 3, width = 7.5)

# Generate a dodged bar plot for percentage of cells
ggplot(split_count_percent_melt, aes(x = celltype, y = Percentage)) +
  geom_col(aes(fill = orig.ident), color = "black", position = "dodge") + 
  theme_bw() + 
  theme(panel.grid = element_blank(),axis.text.x = element_text(angle = 45, hjust = 0.5, vjust = 0.5))
ggsave("./Figure2_scRNA_part/JE_K5_MAGIC_harmony_Percentage_cell_in_each_celltype_normalized_dodge.pdf", height = 3, width = 7.5)

```
## 3.4 Heatmap for celltype percentage in each sample
```{r}
# Load necessary libraries
library(ggplot2)
library(reshape2)
library(data.table)
library(dplyr)

# Define the desired order for celltype
desired_order <- c("Fibroblast","Basal","Cycling","Intermidate","Keratinocyte","JE","Macrophage","Monocyte",
                   "Endothelial cell","T Cell", "Glial cell","Pericyte","Lymphatic Vessel","B cell")
                   
desired_order <- rev(desired_order)



# Extract meta data
md <- JE_K5_MAGIC@meta.data %>% as.data.table
md  # The resulting md object has one "row" per cell

# Count the number of cells per unique combinations of "orig.ident" and "celltype"
cell_counts <- md[, .N, by = c("orig.ident", "celltype")]

# Calculate the total number of cells in each sample (orig.ident)
cell_totals <- cell_counts[, .(total = sum(N)), by = orig.ident]

# Merge the total counts with the cell counts
cell_counts <- merge(cell_counts, cell_totals, by = "orig.ident")

# Calculate the percentage of cells in each celltype within each orig.ident
cell_counts[, Percentage := (N / total) * 100]

# Convert celltype to factor with the desired order
cell_counts$celltype <- factor(cell_counts$celltype, levels = desired_order)

# Generate the heatmap plot
ggplot(cell_counts, aes(x = orig.ident, y = celltype, fill = Percentage)) +
  geom_tile(color = NA) + # Remove the color outline in each tile
  geom_text(aes(label = sprintf("%.1f", Percentage)), color = "black", size = 3) +
  scale_fill_gradient2(low = "#0AC94E", mid = "#FFEEA6", high = "#DD4D46", midpoint = 20, limits = c(0, 40)) +
  labs(title = "Percentage of celltype in each sample",
       x = "Sample Day", y = "Cluster Renamed") +
  theme_minimal() +
  theme(panel.grid = element_blank(),
        plot.title = element_text(hjust = 0.5),
        axis.text.x = element_text(angle = 45, hjust = 1),
        panel.border = element_rect(color = "black", fill = NA, size = 1))

# Save the heatmap plot
ggsave("./Figure2_scRNA_part/JE_K5_MAGIC_harmony_heatmap_cell_proportion.pdf", height = 5, width = 7)

```
## 3.4 



# 4 Feature plot
## 4.1 Whole
1) GFP lor odam
```{r,GFP lor odam whole,fig.width=15,fig.height=15}
FeaturePlot(JE_K5, 
                  features = c("GFP","Lor","Odam"),
                  cols = c("grey85", brewer.pal(9,"YlOrRd")),
                  ncol=2, 
                  pt.size = 0.1,
                  min.cutoff = 0.1,
                  max.cutoff =5,
            label=T,repel = T)
ggsave("./Figure2_scRNA_part/JE_K5_GFP_Lor_Odam.pdf")
```
```{r,GFP lor odam whole magic,fig.width=15,fig.height=15}
DefaultAssay(JE_K5_MAGIC) <- "MAGIC_SCT"
FeaturePlot(JE_K5_MAGIC, 
                  features = c("GFP","Lor","Odam"),
                  cols = c("grey85", brewer.pal(9,"YlOrRd")),
                  ncol=2, 
                  pt.size = 0.1,
                  min.cutoff = 0.1,
                  max.cutoff =5,
            label=T,repel = T)
ggsave("./Figure2_scRNA_part/JE_K5_MAGIC_GFP_Lor_Odam.pdf")
```



##4.2 Seperate

```{r,GFP lor odam split MAGIC,fig.width=25,fig.height=27}
DefaultAssay(JE_K5_MAGIC) <- "MAGIC_SCT"
FeaturePlot(JE_K5_MAGIC, 
                  features = c("GFP","Krt5","Lor","Odam"),
                  cols = c("grey85", brewer.pal(9,"YlOrRd")),
                  ncol=2, split.by  = "orig.ident",
                  pt.size = 0.1,
                  min.cutoff = 1,
                  max.cutoff =5,
            label=T,repel = T)
ggsave("./Figure2_scRNA_part/JE_K5_MAGIC_GFP_Krt5_Lor_Odam_split_1.pdf")
```
```{r,GFP lor odam split MAGIC,fig.width=25,fig.height=27}
DefaultAssay(JE_K5_MAGIC) <- "MAGIC_SCT"
FeaturePlot(JE_K5_MAGIC, 
                  features = c("GFP","Krt5","Lor","Odam"),
                  cols = c("grey85", brewer.pal(9,"YlOrRd")),
                  ncol=2, split.by  = "orig.ident",
                  pt.size = 0.1,
                  min.cutoff = 0.1,
                  max.cutoff =5,
            label=T,repel = T)
ggsave("./Figure2_scRNA_part/JE_K5_MAGIC_GFP_Krt5_Lor_Odam_split_0.1.pdf")
```

#5 GFP percentage in epi 
Here we use violin plot to show GFP+ cells distribution in different celltype between D0 and D5
```{r}

JE_K5_epi_D0_D5 <- subset(JE_K5_epi, orig.ident !="JE_K5_D3") 
```



```{r}
Idents(JE_K5_epi_D0_D5) <- "celltype"
custom_col = c("#F8766D", "#00BA38")
VlnPlot(JE_K5_epi_D0_D5, 
        features = c("GFP"),
        pt.size = 0,
        ncol = 1,split.by = "orig.ident",
        cols = custom_col)
ggsave("./Figure2_scRNA_part/JE_K5_epi_D0_D5_GFP_vlnplot.pdf", height = 4, width = 7)
```










#X save Rdata

```{r}
save(JE_combined, #seurat object fro combined with celltype information
     JE_combined_epi, #seurat object for combined_epi with celltype informationsce_dm, #sce in diffusion map
     JE_K5, # JE_K5 merged data
     JE_K5_epi,# JE_K5_epi population imputated with MAGIC 
     JE_K5_MAGIC, #JE_K5 imputation
     sce, #JE_combined_epi slingshot object
     counts, # count matrix derived from sce
     sce.trade, #sce fitGAM

     file = "./Figure2_scRNA_part/Figure2_scRNA_part.Rdata")
```

# Before shut down Rserver
```{r}
gc()
rm(list=ls())
```

