---
title: "Figure1_plot"
author: "Huan Liu"
date: "2024-06-29"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(
  tidy = TRUE,
  eval = FALSE,
  tidy.opts = list(width.cutoff = 120),
  message = TRUE,
  warning = FALSE,
  cache = TRUE,
  label.duplicate = "append"
)

```

# 1 Load packages and datasets

```{r,load of packages and setup of the environment 1}
gc()
rm(list=ls())
library(Seurat)
library(data.table)
library(scales)
library(plotly)
library(ggplot2)
library(slingshot)
library(magrittr)
library(dplyr)
library(tidyverse)
library(cowplot)
library(gridExtra)
library(viridis)
library(readr)
library(Hmisc)
library(ggpubr)
library(rsample)
library(tidymodels)
library(scales)
library(tradeSeq)
library(pheatmap)
library(scCustomize)
library(destiny)
library(plot3D)
library(rgl)
library(RColorBrewer)
source("./diffprop_functions.R")

set.seed(12)
theme_set(theme_bw())

load(file = "./Figure1_scRNA_part/Figure1_scRNA_part.Rdata")
#JE_combined <- readRDS(file = "./SeuratObject/JE_combined_harmony_20221128.rds")
#JE_combined_epi <-readRDS(file = "./SeuratObject/JE_combined_epi_harmony_MAGIC_renamed.rds")

#sce.big <- readRDS("perio_seurat_20221008.rds")
```

# 2 Cluster information
## 2.1 UMAP
```{r, initial plots}
#group_by_cluster
plot1 = DimPlot(JE_combined, reduction = "umap", pt.size=0.01, label = T, repel=T)
# group_by_sample
plot2 = DimPlot(JE_combined, reduction = "umap", pt.size=0.01, group.by = "orig.ident")
plot3 = DimPlot(JE_combined, reduction = "umap", pt.size=0.01, label = T, split.by  = "orig.ident")
# combine
plotc <- plot1 + plot2
ggsave("./Figure1_scRNA_part/JE_combined_umap.pdf", plot = plotc, width = 20, height = 10)
plot3
ggsave("./Figure1_scRNA_part/JE_combined_umap_split.pdf", plot = plot3, width = 24, height = 10)

DimPlot(JE_combined, reduction = "umap", pt.size=0.01, label = T)
DimPlot(JE_combined, reduction = "umap", pt.size=0.01, label = T,group.by = "orig.ident")

```
## 2.1 List marker genes for each cluster
```{r, set different cluster to different cell type}
new.cluster.ids <- c("1",#0
                     "2",#1
                     "3",#2
                     "4",#3
                     "5",#4
                     "6",#5
                     "7",#6
                     "8", #7
                     "9", #8
                     "10", #9
                     "11", #10
                     "12", #11
                     "13", #12
                     "14", #13
                     "15",#14
                     "16",#15
                     "17" #16
                     )

JE_combined@meta.data$cluster_renamed<- JE_combined@meta.data$cluster_renamed
levels(JE_combined@meta.data$cluster_renamed) <- new.cluster.ids  #cluster_renamed assignment
```

Identification of marker genes refer to `https://github.com/satijalab/seurat/issues/2115` Perform DE using RNA rather than SCT

```{r, generally find marker genes}
Idents(JE_combined) <- JE_combined$cluster_renamed
DefaultAssay(JE_combined) <- "RNA"
JE_combined <- NormalizeData(JE_combined)
all.genes <- rownames(JE_combined)
JE_combined <- ScaleData(JE_combined, features = all.genes)
JE_combined_markers <- FindAllMarkers(object = JE_combined, only.pos = TRUE, 
                               min.pct = 0.25, thresh.use = 0.25) #identify positive marker genes 
top10 <- JE_combined_markers %>% group_by(cluster) %>% top_n(n = 10, wt = avg_log2FC) # You may change n=10 to other number to get top_n genes as you wish.
top6_markers <- Extract_Top_Markers(marker_dataframe = JE_combined_markers, num_genes = 6, named_vector = FALSE,
    make_unique = TRUE)
```

```{r, output tables for marker genes}
write.csv(JE_combined_markers, file = "./Figure1_scRNA_part/JE_combined_markers_20240122.csv", row.names = FALSE)
write.csv(top10, file = "./Figure1_scRNA_part/JE_combined_top10_markers_20240122.csv", row.names = FALSE)


```

## 2.2 Marker gene visualization

Plot heatmap for marker genes

```{r, heatmapplot, fig.width=10, fig.height=18 }

DoHeatmap(JE_combined, features = top10$gene)
ggsave("./Figure1_scRNA_part/JE_combined_markers_top10_20240122.pdf", device = "pdf",#adjust filename accordingly
       width = 30, #adjust according to the display of output
       height = 55, #adjust according to the display of output
       units = "cm")

```

```{r, dotplot for top6 marker genes using RNA,fig.height=20, fig.width=10}

DefaultAssay(JE_combined) <- "RNA"
Clustered_DotPlot(seurat_object = JE_combined, features = top6_markers, k = 12, exp_color_min = -1, exp_color_max = 2,colors_use_exp = PurpleAndYellow())


```

```{r, dotplot for top6 marker genes using SCT,fig.height=20, fig.width=10}

DefaultAssay(JE_combined) <- "SCT"
Clustered_DotPlot(seurat_object = JE_combined, features = top6_markers, k = 12, exp_color_min = -1, exp_color_max = 2,colors_use_exp = PurpleAndYellow())


```

FeaturePlot for top6 genes in each cluster

```{r, top 6 gene plot ,fig.height=15, fig.width=13}
top6 <- JE_combined_markers %>% group_by(cluster) %>% top_n(n = 6, wt = avg_log2FC) # You may change n=10 to other number to get top_n genes as you wish.

DefaultAssay(JE_combined) <- "RNA"
for (i in unique(top6$cluster)) {
  genes_to_plot <- top6$gene[top6$cluster== i]
  genes_to_plot <- genes_to_plot[genes_to_plot %in% rownames(JE_combined)] 
  
  if (length(genes_to_plot) > 0) {
    
      p<- FeaturePlot(JE_combined, 
                  features = genes_to_plot,
                  cols = c("grey85", brewer.pal(9,"YlOrRd")),
                  ncol=2, 
                  pt.size = 0.1,
                  min.cutoff = 0.1,
                  max.cutoff =5)
          print(p)
    # Construct a filename for saving
    file_name <- paste0("./Figure1_scRNA_part/JE_combined_featureplot_RNA_cluster_", i, ".pdf")
    ggsave(filename = file_name, plot = p)
    
  } else {
    print(paste("No genes to plot for cluster", i))
  }
}
```


## 2.3 DPA comparison
```{r, source functions for DPA assay}
source("diffprop_functions.R")
```

```{r, generate the table of cell number}
## Read in file of counts of cells in each population across conditions
md <- JE_combined@meta.data %>% as.data.table 
md  ## the resulting md object has one "row" per cell


obs.counts <- md[, .N, by = c("orig.ident", "cluster_renamed")] %>% dcast(., orig.ident ~ cluster_renamed, value.var = "N")
obs.counts <- obs.counts %>% remove_rownames %>% column_to_rownames(var="orig.ident")
write.csv(obs.counts, file = "./Figure1_scRNA_part/test.csv", row.names = TRUE)


```


```{r, DPA,message = FALSE}
obs.counts = as.matrix(read.csv("./Figure1_scRNA_part/test.csv", row.names = 1))
print(obs.counts)
## Run an example using error (p) of 0.1 and with 100,000 iterations
tip.exp <- generateNull(obs.counts, n=100000, p=0.1);     # Generate the null distribution based on sampling

obs.counts/apply(obs.counts, 1, sum)

### P-value tests for D3 vs D0
two.class.test(obs.counts, tip.exp, cond.control="D0", cond.treatment="D3",to.plot=T);

### P-value tests for D5 vs D0
two.class.test(obs.counts, tip.exp, cond.control="D0", cond.treatment="D5",to.plot=T);

### P-value tests for D5 vs D3
two.class.test(obs.counts, tip.exp, cond.control="D3", cond.treatment="D5",to.plot=T);


```


```{r, Get a table of P-values for a range of 'p' values }

res.table.D3VsD0 = c()
res.table.D5VsD0 = c()
res.table.D5VsD3 = c()

## Go through a series of error probabilities
for (err_prob in c(0.5, 0.4, 0.3, 0.25, 0.2, 0.15, 0.1, 0.05)) {
  tip.exp <- generateNull(obs.counts, n=100000, p=err_prob);
  ## D3 vs D0
  res.1 = two.class.test(obs.counts, tip.exp, cond.control="D0", cond.treatment="D3",to.plot=F)
  res.table.D3VsD0 = rbind(res.table.D3VsD0, res.1)
  ## D5 vs D0
  res.2 = two.class.test(obs.counts, tip.exp, cond.control="D0", cond.treatment="D5",to.plot=F)
  res.table.D5VsD0 = rbind(res.table.D5VsD0, res.2)
  ## D5 vs D3
  res.3 = two.class.test(obs.counts, tip.exp, cond.control="D3", cond.treatment="D5",to.plot=F)
  res.table.D5VsD3 = rbind(res.table.D5VsD3, res.3)
}

rownames(res.table.D3VsD0) = as.character(c(0.5, 0.4, 0.3, 0.25, 0.2, 0.15, 0.1, 0.05))
rownames(res.table.D5VsD0) = as.character(c(0.5, 0.4, 0.3, 0.25, 0.2, 0.15, 0.1, 0.05))
rownames(res.table.D5VsD3) = as.character(c(0.5, 0.4, 0.3, 0.25, 0.2, 0.15, 0.1, 0.05))


write.csv(res.table.D3VsD0, file = "./Figure1_scRNA_part/JE_combined_res.table.D3VsD0.csv", row.names = FALSE)
write.csv(res.table.D5VsD0, file = "./Figure1_scRNA_part/JE_combined_res.table.D5VsD0.csv", row.names = FALSE)
write.csv(res.table.D5VsD3, file = "./Figure1_scRNA_part/JE_combined_res.table.D5VsD3.csv", row.names = FALSE)

print("done")
```

## 2.4 cluster proportion display
```{r, check umap }
DimPlot(JE_combined, reduction = "umap", pt.size=0.01, label = T)
DimPlot(JE_combined, reduction = "umap", pt.size=0.01, label = T,group.by = "orig.ident")

```

```{r}
# Load necessary libraries
library(Seurat)
library(data.table)
library(ggplot2)
library(reshape2)
library(dplyr)

# Extract meta data
md <- JE_combined@meta.data %>% as.data.table
md  # The resulting md object has one "row" per cell

# Count the number of cells per unique combinations of "orig.ident" and "cluster_renamed"
cell_counts <- md[, .N, by = c("orig.ident", "cluster_renamed")]

# Cast the data from long to wide format
split_count <- dcast(cell_counts, orig.ident ~ cluster_renamed, value.var = "N", fill = 0)

# Melt the data back to long format for ggplot2
split_count_melt <- melt(split_count, id.vars = "orig.ident", variable.name = "cluster_renamed", value.name = "Number")

# Save the cell count data to a CSV file
write.csv(split_count_melt, file = "./Figure1_scRNA_part/JE_combined_harmony_cell_number_cluster_renamed.csv", row.names = FALSE)

# Define the desired order for cluster_renamed
desired_order <- c(1, 6, 2, 3, 4, 5, 9, 10, 7, 8, 11, 12, 13, 14, 15, 16, 17)

# Convert cluster_renamed to factor with the desired order
split_count_melt$cluster_renamed <- factor(split_count_melt$cluster_renamed, levels = desired_order)

# Generate a stacked bar plot with a white theme and black border for unnormalized data
ggplot(split_count_melt, aes(fill = orig.ident, x = cluster_renamed, y = Number)) +
  geom_bar(position = "fill", stat = "identity") +
  ggtitle("Percentage of cells in each cluster") +
  xlab("cluster_renamed") +
  ylab("Percentage of cells") +
  theme_classic() +
  theme(plot.title = element_text(hjust = 0.5),
        panel.border = element_rect(color = "black", fill = NA, size = 0.5))

ggsave("./Figure1_scRNA_part/JE_combined_harmony_Percentage_cell_in_each_cluster_renamed_unnormalized.pdf", height = 3, width = 7.5)

# Normalize cell counts to the total number in each sample
split_count$total <- rowSums(split_count[, -1])

# Calculate the percentage for each cluster
split_count_percent <- split_count %>%
  mutate(across(-c(orig.ident, total), ~ . / total * 100, .names = "{.col}_percent"))

# Reshape data for ggplot2
split_count_percent_melt <- melt(split_count_percent, id.vars = "orig.ident", 
                                 variable.name = "cluster_renamed", 
                                 value.name = "Percentage",
                                 measure.vars = grep("_percent$", names(split_count_percent), value = TRUE))

# Remove "_percent" from cluster_renamed
split_count_percent_melt$cluster_renamed <- gsub("_percent", "", split_count_percent_melt$cluster_renamed)

# Filter out rows with NA in cluster_renamed
split_count_percent_melt <- split_count_percent_melt[!is.na(split_count_percent_melt$cluster_renamed), ]

# Convert cluster_renamed to factor with the desired order
split_count_percent_melt$cluster_renamed <- factor(split_count_percent_melt$cluster_renamed, levels = desired_order)

# Save the percentage data to a CSV file
write.csv(split_count_percent_melt, file = "./Figure1_scRNA_part/JE_combined_harmony_cell_percentage_cluster_renamed.csv", row.names = FALSE)

# Generate a stacked bar plot with a white theme and black border for normalized data
ggplot(split_count_percent_melt, aes(fill = orig.ident, x = cluster_renamed, y = Percentage)) +
  geom_bar(position = "fill", stat = "identity") +
  ggtitle("Percentage of cells in each cluster_renamed") +
  xlab("cluster_renamed") +
  ylab("Percentage of cells") +
  theme_classic() +
  theme(plot.title = element_text(hjust = 0.5),
        panel.border = element_rect(color = "black", fill = NA, size = 1))

ggsave("./Figure1_scRNA_part/JE_combined_harmony_Percentage_cell_in_each_cluster_renamed_normalized.pdf", height = 3, width = 7.5)

# Generate a stacked bar plot for percentage of cells (alternative layout)
ggplot(split_count_percent_melt, aes(x = cluster_renamed, y = Percentage)) +
  geom_col(aes(fill = orig.ident), color = "black") + 
  theme_bw() + 
  theme(panel.grid = element_blank())
ggsave("./Figure1_scRNA_part/JE_combined_harmony_Percentage_cell_in_each_celltype_normalized_stack.pdf", height = 3, width = 7.5)

# Generate a dodged bar plot for percentage of cells
ggplot(split_count_percent_melt, aes(x = cluster_renamed, y = Percentage)) +
  geom_col(aes(fill = orig.ident), color = "black", position = "dodge") + 
  theme_bw() + 
  theme(panel.grid = element_blank())
ggsave("./Figure1_scRNA_part/JE_combined_harmony_Percentage_cell_in_each_cluster_renamed_normalized_dodge.pdf", height = 3, width = 7.5)

```


## 2.5 Heatmap for cluster percentage in each day
```{r}
# Load necessary libraries
library(ggplot2)
library(reshape2)
library(data.table)
library(dplyr)

# Define the desired order for cluster_renamed
desired_order <- c(17, 16, 15, 14, 13, 12, 11, 8, 7, 10, 9, 5, 4, 3, 2, 6, 1)

# Extract meta data
md <- JE_combined@meta.data %>% as.data.table
md  # The resulting md object has one "row" per cell

# Count the number of cells per unique combinations of "orig.ident" and "cluster_renamed"
cell_counts <- md[, .N, by = c("orig.ident", "cluster_renamed")]

# Calculate the total number of cells in each sample (orig.ident)
cell_totals <- cell_counts[, .(total = sum(N)), by = orig.ident]

# Merge the total counts with the cell counts
cell_counts <- merge(cell_counts, cell_totals, by = "orig.ident")

# Calculate the percentage of cells in each cluster_renamed within each orig.ident
cell_counts[, Percentage := (N / total) * 100]

# Convert cluster_renamed to factor with the desired order
cell_counts$cluster_renamed <- factor(cell_counts$cluster_renamed, levels = desired_order)

# Generate the heatmap plot
ggplot(cell_counts, aes(x = orig.ident, y = cluster_renamed, fill = Percentage)) +
  geom_tile(color = NA) + # Remove the color outline in each tile
  geom_text(aes(label = sprintf("%.1f", Percentage)), color = "black", size = 3) +
  scale_fill_gradient2(low = "#0AC94E", mid = "#FFEEA6", high = "#DD4D46", midpoint = 12.5, limits = c(0, 25)) +
  labs(title = "Percentage of cluster_renamed in each sample",
       x = "Sample Day", y = "Cluster Renamed") +
  theme_minimal() +
  theme(panel.grid = element_blank(),
        plot.title = element_text(hjust = 0.5),
        axis.text.x = element_text(angle = 45, hjust = 1),
        panel.border = element_rect(color = "black", fill = NA, size = 1))

# Save the heatmap plot
ggsave("./Figure1_scRNA_part/JE_combined_harmony_heatmap_cell_proportion.pdf", height = 5, width = 7)

```
##2.6 Dotplot for features
```{r, setup gene list}
#markers refer to https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7359078/ and marker genes in each cluster
genes_to_check <- c("Col1a1", "Postn","Nfia", #Dermal
                    "Epcam","Krt14","Krt24","Krt5","Mki67","Krtdap","Atf3",  #Epithelium
                    "Ccl3","Cxcl2", #Macrophage
                    "Lyz2","Cd74", #Monocyte
                    "Plvap","Egfl7",#Endothelial cell
                    "Icos","Cxcr6", #T cell
                    "Mpz","Plp1", #Glial cell
                    "Rgs5","Myh11", #Pericyte,
                    "Ccl21a","Mmrn1", #Lymphatic endothelial cell
                    "Hbb-bt","Hba-a1", #Erythroid cell
                    "Cd79a","Cd79b" #B cell
                             )
```


```{r,dotplot for marker genes}

# Define the desired order for cluster_renamed
desired_order <- c(17, 16, 15, 14, 13, 12, 11, 8, 7, 10, 9, 5, 4, 3, 2, 6, 1)

# Set the identities in the Seurat object to cluster_renamed
JE_combined$cluster_renamed <- factor(JE_combined$cluster_renamed, levels = desired_order)
Idents(JE_combined) <- JE_combined$cluster_renamed

# Generate the dot plot
DotPlot(JE_combined, features = unique(genes_to_check)) +
  theme_bw() +
  theme(panel.grid = element_blank(), 
        axis.text.x = element_text(angle = 45, hjust = 0.5, vjust = 0.5),
        panel.border = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_blank()) +
  labs(x = NULL, y = NULL) + 
  guides(size = guide_legend(order = 3)) +
  scale_color_gradientn(values = seq(0, 1, 0.2), colours = c('#295B9F', '#FFFFFF', '#D23B3E'))

# Save the dot plot
ggsave("./Figure1_scRNA_part/JE_combined_harmony_dotplot_feature.pdf", width = 8, height = 5)
```

## 2.7 Celltype assignment.

```{r, set different cluster to different cell type}
new.cluster.ids <- c("Fibroblast",#1( Postn, Col1a1, Col1a2)
                     "Epithelium",#2(Krt24, Selenbp1)
                     "Epithelium",#3(Krt15, Pappa)
                     "Epithelium",#4(Mki67, Top2a)
                     "Epithelium",#5(Krtdap, Krt4)
                     "Fibroblast", #6(Pi16, Sfrp2)
                     "Macrophage", #7(Ccl3, Cxcl2)
                     "Monocyte", #8(Lyz2, Cd74)
                     "Epithelium", #9(Atf3, Jun)
                     "Epithelium", #10(Odam, Cdo1)
                     "Endothelial cell", #11(Plvap, Egfl7)
                     "T cell", #12(Icos, Cxcr6)
                     "Glial cell", #13(Mpz,Plp1)
                     "Pericyte",#14(Rgs5,Myh11,Tagln)
                     "Lymphatic vessels",#15(Ccl21a,Mmrn1)
                     "Erythroid cell", #16(Hbb-bt, Hba-a1)
                     "B cell" #17 (Cd79a, Cd79b)
                     )

JE_combined@meta.data$celltype<- JE_combined@meta.data$seurat_clusters
levels(JE_combined@meta.data$celltype) <- new.cluster.ids  #celltype assignment
```

```{r, check umap }
Idents(JE_combined) <- JE_combined$celltype
DimPlot(JE_combined, reduction = "umap", pt.size=0.01, label = T, repel=T)
DimPlot(JE_combined, reduction = "umap", pt.size=0.01, label = T,repel=T, group.by = "orig.ident")

```

# 3 Epithelium cluster information
## 3.0 UMAP
```{r, initial plots}
Idents(JE_combined_epi) <- JE_combined_epi$celltype
#group_by_cluster
plot1 = DimPlot(JE_combined_epi, reduction = "umap", pt.size=0.01, label = T, repel=T)
# group_by_sample
plot2 = DimPlot(JE_combined_epi, reduction = "umap", pt.size=0.01, group.by = "orig.ident")
plot3 = DimPlot(JE_combined_epi, reduction = "umap", pt.size=0.01, label = T, split.by  = "orig.ident")
# combine
plotc <- plot1 + plot2
ggsave("./Figure1_scRNA_part/JE_combined_epi_umap.pdf", plot = plotc, width = 20, height = 10)
plot3
ggsave("./Figure1_scRNA_part/JE_combined_epi_umap_split.pdf", plot = plot3, width = 24, height = 10)

DimPlot(JE_combined_epi, reduction = "umap", pt.size=0.01, label = T)
DimPlot(JE_combined_epi, reduction = "umap", pt.size=0.01, label = T,group.by = "orig.ident")

```
## 3.1 Marker genes for each celltype
```{r, generally find marker genes}
Idents(JE_combined_epi) <- JE_combined_epi$celltype
DefaultAssay(JE_combined_epi) <- "RNA"
JE_combined_epi <- NormalizeData(JE_combined_epi)
all.genes <- rownames(JE_combined_epi)
JE_combined_epi <- ScaleData(JE_combined_epi, features = all.genes)
JE_combined_epi_markers <- FindAllMarkers(object = JE_combined_epi, only.pos = TRUE, 
                               min.pct = 0.25, thresh.use = 0.25) #identify positive marker genes 
top10 <- JE_combined_epi_markers %>% group_by(cluster) %>% top_n(n = 10, wt = avg_log2FC) # You may change n=10 to other number to get top_n genes as you wish.
top6_markers <- Extract_Top_Markers(marker_dataframe = JE_combined_epi_markers, num_genes = 6, named_vector = FALSE,
    make_unique = TRUE)
```

```{r, output tables for marker genes}
write.csv(JE_combined_epi_markers, file = "./Figure1_scRNA_part/JE_combined_epi_markers_20240122.csv", row.names = FALSE)
write.csv(top10, file = "./Figure1_scRNA_part/JE_combined_epi_top10_markers_20240122.csv", row.names = FALSE)


```

## 3.2 Marker gene visualization

Plot heatmap for marker genes

```{r, heatmapplot, fig.width=10, fig.height=18 }

DoHeatmap(JE_combined_epi, features = top10$gene)
ggsave("./Figure1_scRNA_part/JE_combined_epi_markers_top10_20240122.pdf", device = "pdf",#adjust filename accordingly
       width = 30, #adjust according to the display of output
       height = 55, #adjust according to the display of output
       units = "cm")

```

```{r, dotplot for top6 marker genes using RNA,fig.height=20, fig.width=10}

DefaultAssay(JE_combined_epi) <- "RNA"
Clustered_DotPlot(seurat_object = JE_combined_epi, features = top6_markers, k = 12, exp_color_min = -1, exp_color_max = 2,colors_use_exp = PurpleAndYellow())


```

```{r, dotplot for top6 marker genes using SCT,fig.height=20, fig.width=10}

DefaultAssay(JE_combined_epi) <- "SCT"
Clustered_DotPlot(seurat_object = JE_combined_epi, features = top6_markers, k = 12, exp_color_min = -1, exp_color_max = 2,colors_use_exp = PurpleAndYellow())


```

FeaturePlot for top6 genes in each cluster

```{r, top 6 gene plot ,fig.height=15, fig.width=13}
top6 <- JE_combined_epi_markers %>% group_by(cluster) %>% top_n(n = 6, wt = avg_log2FC) # You may change n=10 to other number to get top_n genes as you wish.

DefaultAssay(JE_combined_epi) <- "MAGIC_SCT"
for (i in unique(top6$cluster)) {
  genes_to_plot <- top6$gene[top6$cluster== i]
  genes_to_plot <- genes_to_plot[genes_to_plot %in% rownames(JE_combined_epi)] 
  
  if (length(genes_to_plot) > 0) {
    
      p<- FeaturePlot(JE_combined_epi, 
                  features = genes_to_plot,
                  cols = c("grey85", brewer.pal(9,"YlOrRd")),
                  ncol=2, 
                  pt.size = 0.1,
                  min.cutoff = 0.1,
                  max.cutoff =5)
          print(p)
    # Construct a filename for saving
    file_name <- paste0("./Figure1_scRNA_part/JE_combined_epi_featureplot_MAGIC_SCT_celltype_", i, ".pdf")
    ggsave(filename = file_name, plot = p)
    
  } else {
    print(paste("No genes to plot for cluster", i))
  }
}
```

## 3.3 cluster proportion display
```{r, check umap }
DimPlot(JE_combined_epi, reduction = "umap", pt.size=0.01, label = T)
DimPlot(JE_combined_epi, reduction = "umap", pt.size=0.01, label = T,group.by = "orig.ident")

```

```{r}
# Load necessary libraries
library(Seurat)
library(data.table)
library(ggplot2)
library(reshape2)
library(dplyr)

# Extract meta data
md <- JE_combined_epi@meta.data %>% as.data.table
md  # The resulting md object has one "row" per cell

# Count the number of cells per unique combinations of "orig.ident" and "celltype"
cell_counts <- md[, .N, by = c("orig.ident", "celltype")]

# Cast the data from long to wide format
split_count <- dcast(cell_counts, orig.ident ~ celltype, value.var = "N", fill = 0)

# Melt the data back to long format for ggplot2
split_count_melt <- melt(split_count, id.vars = "orig.ident", variable.name = "celltype", value.name = "Number")

# Save the cell count data to a CSV file
write.csv(split_count_melt, file = "./Figure1_scRNA_part/JE_combined_epi_harmony_cell_number_celltype.csv", row.names = FALSE)

# Define the desired order for celltype
desired_order <- c("GE2","GE4","GE8","GE1","GE3","GE6","GE5","GE9","GE7")


# Convert celltype to factor with the desired order
split_count_melt$celltype <- factor(split_count_melt$celltype, levels = desired_order)

# Generate a stacked bar plot with a white theme and black border for unnormalized data
ggplot(split_count_melt, aes(fill = orig.ident, x = celltype, y = Number)) +
  geom_bar(position = "fill", stat = "identity") +
  ggtitle("Percentage of cells in each cluster") +
  xlab("celltype") +
  ylab("Percentage of cells") +
  theme_classic() +
  theme(plot.title = element_text(hjust = 0.5),
        panel.border = element_rect(color = "black", fill = NA, size = 0.5))

ggsave("./Figure1_scRNA_part/JE_combined_epi_harmony_Percentage_cell_in_each_celltype_unnormalized.pdf", height = 3, width = 7.5)

# Normalize cell counts to the total number in each sample
split_count$total <- rowSums(split_count[, -1])

# Calculate the percentage for each cluster
split_count_percent <- split_count %>%
  mutate(across(-c(orig.ident, total), ~ . / total * 100, .names = "{.col}_percent"))

# Reshape data for ggplot2
split_count_percent_melt <- melt(split_count_percent, id.vars = "orig.ident", 
                                 variable.name = "celltype", 
                                 value.name = "Percentage",
                                 measure.vars = grep("_percent$", names(split_count_percent), value = TRUE))

# Remove "_percent" from celltype
split_count_percent_melt$celltype <- gsub("_percent", "", split_count_percent_melt$celltype)

# Filter out rows with NA in celltype
split_count_percent_melt <- split_count_percent_melt[!is.na(split_count_percent_melt$celltype), ]

# Convert celltype to factor with the desired order
split_count_percent_melt$celltype <- factor(split_count_percent_melt$celltype, levels = desired_order)

# Save the percentage data to a CSV file
write.csv(split_count_percent_melt, file = "./Figure1_scRNA_part/JE_combined_epi_harmony_cell_percentage_celltype.csv", row.names = FALSE)

# Generate a stacked bar plot with a white theme and black border for normalized data
ggplot(split_count_percent_melt, aes(fill = orig.ident, x = celltype, y = Percentage)) +
  geom_bar(position = "fill", stat = "identity") +
  ggtitle("Percentage of cells in each celltype") +
  xlab("celltype") +
  ylab("Percentage of cells") +
  theme_classic() +
  theme(plot.title = element_text(hjust = 0.5),
        panel.border = element_rect(color = "black", fill = NA, size = 1))

ggsave("./Figure1_scRNA_part/JE_combined_epi_harmony_Percentage_cell_in_each_celltype_normalized.pdf", height = 3, width = 7.5)

# Generate a stacked bar plot for percentage of cells (alternative layout)
ggplot(split_count_percent_melt, aes(x = celltype, y = Percentage)) +
  geom_col(aes(fill = orig.ident), color = "black") + 
  theme_bw() + 
  theme(panel.grid = element_blank())
ggsave("./Figure1_scRNA_part/JE_combined_epi_harmony_Percentage_cell_in_each_celltype_normalized_stack.pdf", height = 3, width = 7.5)

# Generate a dodged bar plot for percentage of cells
ggplot(split_count_percent_melt, aes(x = celltype, y = Percentage)) +
  geom_col(aes(fill = orig.ident), color = "black", position = "dodge") + 
  theme_bw() + 
  theme(panel.grid = element_blank())
ggsave("./Figure1_scRNA_part/JE_combined_epi_harmony_Percentage_cell_in_each_celltype_normalized_dodge.pdf", height = 3, width = 7.5)

```


## 3.4 Heatmap for cluster percentage in each day
```{r}
# Load necessary libraries
library(ggplot2)
library(reshape2)
library(data.table)
library(dplyr)

# Define the desired order for celltype
desired_order <- c("GE7","GE9","GE5","GE6","GE3","GE1","GE8","GE4","GE2")

# Extract meta data
md <- JE_combined_epi@meta.data %>% as.data.table
md  # The resulting md object has one "row" per cell

# Count the number of cells per unique combinations of "orig.ident" and "celltype"
cell_counts <- md[, .N, by = c("orig.ident", "celltype")]

# Calculate the total number of cells in each sample (orig.ident)
cell_totals <- cell_counts[, .(total = sum(N)), by = orig.ident]

# Merge the total counts with the cell counts
cell_counts <- merge(cell_counts, cell_totals, by = "orig.ident")

# Calculate the percentage of cells in each celltype within each orig.ident
cell_counts[, Percentage := (N / total) * 100]

# Convert celltype to factor with the desired order
cell_counts$celltype <- factor(cell_counts$celltype, levels = desired_order)

# Generate the heatmap plot
ggplot(cell_counts, aes(x = orig.ident, y = celltype, fill = Percentage)) +
  geom_tile(color = NA) + # Remove the color outline in each tile
  geom_text(aes(label = sprintf("%.1f", Percentage)), color = "black", size = 3) +
  scale_fill_gradient2(low = "#0AC94E", mid = "#FFEEA6", high = "#DD4D46", midpoint = 12.5, limits = c(0, 25)) +
  labs(title = "Percentage of celltype in each sample",
       x = "Sample Day", y = "Cluster Renamed") +
  theme_minimal() +
  theme(panel.grid = element_blank(),
        plot.title = element_text(hjust = 0.5),
        axis.text.x = element_text(angle = 45, hjust = 1),
        panel.border = element_rect(color = "black", fill = NA, size = 1))

# Save the heatmap plot
ggsave("./Figure1_scRNA_part/JE_combined_epi_harmony_heatmap_cell_proportion.pdf", height = 5, width = 7)

```

##2.6 Dotplot for features
```{r, setup gene list}
#markers refer to marker genes in each cluster
genes_to_check <- c("Selenbp1","Krtdap","Lor","Rps2","Krt14", #GE2_4_8
                    "Pappa", "Col17a1","Nfia","Krt5", #GE1
                    "Mki67","Top2a", #GE3
                    "mt−Nd5","Lars2", #GE6
                    "Atf3","Klf6","Klf6", #GE5
                    "Lamc2","Tgfbi", #GE9
                    "Cxcl5","Odam","Cdo1" #GE7
                             )
```


```{r,dotplot for marker genes}
DefaultAssay(JE_combined_epi) <- "SCT"
# Define the desired order for celltype
desired_order <- c("GE7","GE9","GE5","GE6","GE3","GE1","GE8","GE4","GE2")

# Set the identities in the Seurat object to celltype
JE_combined_epi$celltype <- factor(JE_combined_epi$celltype, levels = desired_order)
Idents(JE_combined_epi) <- JE_combined_epi$celltype

# Generate the dot plot
DotPlot(JE_combined_epi, features = unique(genes_to_check)) +
  theme_bw() +
  theme(panel.grid = element_blank(), 
        axis.text.x = element_text(angle = 45, hjust = 0.5, vjust = 0.5),
        panel.border = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_blank()) +
  labs(x = NULL, y = NULL) + 
  guides(size = guide_legend(order = 3)) +
  scale_color_gradientn(values = seq(0, 1, 0.2), colours = c('#295B9F', '#FFFFFF', '#D23B3E'))

# Save the dot plot
ggsave("./Figure1_scRNA_part/JE_combined_epi_harmony_dotplot_feature.pdf", width = 6.5, height = 3)
```

## 3.7 DPA comparison
```{r, source functions for DPA assay}
source("diffprop_functions.R")
```
```{r, generate the table of cell number}
## Read in file of counts of cells in each population across conditions
md <- JE_combined_epi@meta.data %>% as.data.table 
md  ## the resulting md object has one "row" per cell


obs.counts <- md[, .N, by = c("orig.ident", "celltype")] %>% dcast(., orig.ident ~ celltype, value.var = "N")
obs.counts <- obs.counts %>% remove_rownames %>% column_to_rownames(var="orig.ident")
write.csv(obs.counts, file = "./Figure1_scRNA_part/test_epi.csv", row.names = TRUE)


```


```{r, DPA,message = FALSE}
obs.counts = as.matrix(read.csv("./Figure1_scRNA_part/test_epi.csv", row.names = 1))
print(obs.counts)
## Run an example using error (p) of 0.1 and with 100,000 iterations
tip.exp.epi <- generateNull(obs.counts, n=100000, p=0.1);     # Generate the null distribution based on sampling

obs.counts/apply(obs.counts, 1, sum)

### P-value tests for D3 vs D0
two.class.test(obs.counts, tip.exp.epi, cond.control="D0", cond.treatment="D3",to.plot=T);

### P-value tests for D5 vs D0
two.class.test(obs.counts, tip.exp.epi, cond.control="D0", cond.treatment="D5",to.plot=T);

### P-value tests for D5 vs D3
two.class.test(obs.counts, tip.exp.epi, cond.control="D3", cond.treatment="D5",to.plot=T);


```


```{r, Get a table of P-values for a range of 'p' values }

res.table.D3VsD0 = c()
res.table.D5VsD0 = c()
res.table.D5VsD3 = c()

## Go through a series of error probabilities
for (err_prob in c(0.5, 0.4, 0.3, 0.25, 0.2, 0.15, 0.1, 0.05)) {
  tip.exp.epi <- generateNull(obs.counts, n=100000, p=err_prob);
  ## D3 vs D0
  res.1 = two.class.test(obs.counts, tip.exp.epi, cond.control="D0", cond.treatment="D3",to.plot=F)
  res.table.D3VsD0 = rbind(res.table.D3VsD0, res.1)
  ## D5 vs D0
  res.2 = two.class.test(obs.counts, tip.exp.epi, cond.control="D0", cond.treatment="D5",to.plot=F)
  res.table.D5VsD0 = rbind(res.table.D5VsD0, res.2)
  ## D5 vs D3
  res.3 = two.class.test(obs.counts, tip.exp.epi, cond.control="D3", cond.treatment="D5",to.plot=F)
  res.table.D5VsD3 = rbind(res.table.D5VsD3, res.3)
}

rownames(res.table.D3VsD0) = as.character(c(0.5, 0.4, 0.3, 0.25, 0.2, 0.15, 0.1, 0.05))
rownames(res.table.D5VsD0) = as.character(c(0.5, 0.4, 0.3, 0.25, 0.2, 0.15, 0.1, 0.05))
rownames(res.table.D5VsD3) = as.character(c(0.5, 0.4, 0.3, 0.25, 0.2, 0.15, 0.1, 0.05))


write.csv(res.table.D3VsD0, file = "./Figure1_scRNA_part/JE_combined_epi_res.table.D3VsD0.csv", row.names = FALSE)
write.csv(res.table.D5VsD0, file = "./Figure1_scRNA_part/JE_combined_epi_res.table.D5VsD0.csv", row.names = FALSE)
write.csv(res.table.D5VsD3, file = "./Figure1_scRNA_part/JE_combined_epi_res.table.D5VsD3.csv", row.names = FALSE)

print("done")
```

# 4 Feature plot
## 4.1 Module plot
```{r, gene set Feature plot for krt gene, fig.width=5, fig.height=5}
basal_marker_gene_list <- list(c("Col17a1", "Krt5"))
top_marker_gene_list <- list(c("Krtdap", "Lor"))
object <- AddModuleScore(object = JE_combined_epi, features = basal_marker_gene_list, name = "basal_marker_gene")
FeaturePlot(object = object, features = "basal_marker_gene1",pt.size = 0.1)+
  scale_color_viridis(discrete = FALSE, option="turbo")
ggsave("./Figure1_scRNA_part/JE_combined_epi_krt_basal_module_feature.pdf", device = "pdf", width = 15, height = 15, units = "cm")
object <- AddModuleScore(object = JE_combined_epi, features = top_marker_gene_list, name = "top_marker_gene")
FeaturePlot(object = object, features = "top_marker_gene1",pt.size = 0.1)+
  scale_color_viridis(discrete = FALSE, option="turbo")
ggsave("./Figure1_scRNA_part/JE_combined_epi_krt_top_module_feature.pdf", device = "pdf", width = 15, height = 15, units = "cm")
```
## 4.2 gene plot

## Odam and Lor in mouse
Prepare packages and datasets
```{r,load packages}
#ggplot作图
library(ggplot2)
library(scales)
library(ggnewscale)
```

```{r, extract expression matrix}
#提取表达数据（scaled）
exp <- JE_combined_epi@assays[["MAGIC_SCT"]]@data
exp <- as.data.frame(exp)#行为基因，列是细胞
#提取UMAP坐标
position=JE_combined_epi@reductions$umap@cell.embeddings
position <- as.data.frame(position)
position$cell <- rownames(position)
```

```{r, extract gene expression for genes of interest,fig.width=8,fig.height=7}
# 构建作图数据
gene <- c("Krt5", "Odam", "Lor") # Blue color for Odam, Green color for Lor

data_gene <- position
for (i in 1:length(gene)) {
  gene_exp <- exp[gene[i],]
  gene_exp <- t(gene_exp)
  gene_exp <- as.data.frame(gene_exp)
  gene_exp$cell <- rownames(gene_exp)
  data_gene <- merge(data_gene, gene_exp, by='cell')
}

colnames(data_gene)
rownames(data_gene) <- data_gene$cell
data_gene <- data_gene[, -1]

# 设定阈值
threshold <- 0.5

# 提取表达这些基因的细胞并筛选表达量大于阈值的点

data_Odam <- data_gene[, c(1, 2, 4)]
data_Odam <- data_Odam[which(data_Odam$Odam > threshold),]

data_Lor <- data_gene[, c(1, 2, 5)]
data_Lor <- data_Lor[which(data_Lor$Lor > threshold),]

# 设置绘图参数
point_size <- 1.0
point_alpha <- 0.6

ggplot() +
  new_scale("color") +
  geom_point(data = data_Odam, aes(x = UMAP_1, y = UMAP_2, colour = Odam), shape = 16, size = point_size, alpha = point_alpha) +
  scale_colour_gradient(low = "lightgrey", high = "#619CFF") +
  new_scale("color") +
  geom_point(data = data_Lor, aes(x = UMAP_1, y = UMAP_2, colour = Lor), shape = 16, size = point_size, alpha = point_alpha) +
  scale_colour_gradient(low = "lightgrey", high = "#00BA38") +
  geom_point(data = data_gene, aes(x = UMAP_1, y = UMAP_2), size = 0.5, shape = 16, color = 'lightgrey', alpha = 0.8) +
    theme_minimal() +
  theme(
    panel.grid = element_blank(),  # 移除网格线
    panel.border = element_rect(color = "black", fill = NA, size = 1)  # 添加黑色边框
  )
ggsave("./Figure1_scRNA_part/JE_K5_epi_odam_umap.pdf")
```

## Krt5
```{r}
FeaturePlot(JE_combined_epi, features = c("Krt5"),
            cols = c("grey85",brewer.pal(9,"YlOrRd")),
            split.by = "orig.ident",label = T,repel = T,
            ncol=3, pt.size = 0.3)
ggsave("./Figure1_scRNA_part/JE_combined_epi_krt5_split.pdf", device = "pdf", width = 11, height = 4)

```
## Krt14
```{r}
FeaturePlot(JE_combined_epi, features = c("Krt14"),
            cols = c("grey85",brewer.pal(9,"YlOrRd")),
            split.by = "orig.ident",label = T,repel = T,
            ncol=3, pt.size = 0.3)
ggsave("./Figure1_scRNA_part/JE_combined_epi_krt14_split.pdf", device = "pdf", width = 11, height = 4)

```
## Procr
```{r,fig.height=6, fig.width=5}
FeaturePlot(JE_combined_epi, features = c("Procr"),
            cols = c("grey85",brewer.pal(9,"YlOrRd")),
            label = T,repel = T,
             pt.size = 0.3)
ggsave("./Figure1_scRNA_part/JE_combined_epi_Procr.pdf", device = "pdf", width = 6, height = 5)

```
```{r,fig.height=6, fig.width=5}
FeaturePlot(JE_combined, features = c("Procr"),
            cols = c("grey85",brewer.pal(9,"YlOrRd")),
            label = T,repel = T,
             pt.size = 0.3)
ggsave("./Figure1_scRNA_part/JE_combined_Procr.pdf", device = "pdf", width = 6, height = 5)

```


```{r,fig.height=6, fig.width=16}
FeaturePlot(JE_combined_epi, features = c("Procr"),
            cols = c("grey85",brewer.pal(9,"YlOrRd")),
             split.by = "orig.ident",label = T,repel = T,
            ncol=3, pt.size = 0.3)
ggsave("./Figure1_scRNA_part/JE_combined_epi_Procr_split.pdf", device = "pdf", width = 16, height = 5)

```
```{r,fig.height=6, fig.width=16}
FeaturePlot(JE_combined, features = c("Procr"),
            cols = c("grey85",brewer.pal(9,"YlOrRd")),
             split.by = "orig.ident",label = T,repel = T,
            ncol=3, pt.size = 0.3)
ggsave("./Figure1_scRNA_part/JE_combined_Procr_split.pdf", device = "pdf", width = 16, height = 5)

```

```{r, stem cell genes feature plot, fig.height=5, fig.width=6}
library(RColorBrewer)
FeaturePlot(sce.big, features = c("PROCR"),
            cols = c("grey85",brewer.pal(9,"YlOrRd")),
            label = T,repel = T, pt.size = 0.1)
ggsave("./Figure1_scRNA_part/Human_perio_PROCR.pdf", device = "pdf", width = 6, height = 5)

```


```{r,fig.height=6, fig.width=11}
FeaturePlot(sce.big, features = c("PROCR"),
            cols = c("grey85",brewer.pal(9,"YlOrRd")),
             split.by = "orig.ident",label = T,repel = T,
            ncol=2, pt.size = 0.3)
ggsave("./Figure1_scRNA_part/Human_perio_PROCR_split.pdf", device = "pdf", width = 11, height = 5)

```
## Lgr5
```{r,fig.height=6, fig.width=5}
FeaturePlot(JE_combined_epi, features = c("Lgr5"),
            cols = c("grey85",brewer.pal(9,"YlOrRd")),
            label = T,repel = T,
             pt.size = 0.3)
ggsave("./Figure1_scRNA_part/JE_combined_epi_Lgr5.pdf", device = "pdf", width = 6, height = 5)

```
```{r,fig.height=6, fig.width=5}
FeaturePlot(JE_combined, features = c("Lgr5"),
            cols = c("grey85",brewer.pal(9,"YlOrRd")),
            label = T,repel = T,
             pt.size = 0.3)
ggsave("./Figure1_scRNA_part/JE_combined_Lgr5.pdf", device = "pdf", width = 6, height = 5)

```


```{r,fig.height=6, fig.width=16}
FeaturePlot(JE_combined_epi, features = c("Lgr5"),
            cols = c("grey85",brewer.pal(9,"YlOrRd")),
             split.by = "orig.ident",label = T,repel = T,
            ncol=3, pt.size = 0.3)
ggsave("./Figure1_scRNA_part/JE_combined_epi_Lgr5_split.pdf", device = "pdf", width = 16, height = 5)

```
```{r,fig.height=6, fig.width=16}
FeaturePlot(JE_combined, features = c("Lgr5"),
            cols = c("grey85",brewer.pal(9,"YlOrRd")),
             split.by = "orig.ident",label = T,repel = T,
            ncol=3, pt.size = 0.3)
ggsave("./Figure1_scRNA_part/JE_combined_Lgr5_split.pdf", device = "pdf", width = 16, height = 5)

```

```{r, stem cell genes feature plot, fig.height=5, fig.width=6}
library(RColorBrewer)
FeaturePlot(sce.big, features = c("LGR5"),
            cols = c("grey85",brewer.pal(9,"YlOrRd")),
            label = T,repel = T, pt.size = 0.1)
ggsave("./Figure1_scRNA_part/Human_perio_LGR5.pdf", device = "pdf", width = 6, height = 5)

```


```{r,fig.height=6, fig.width=11}
FeaturePlot(sce.big, features = c("LGR5"),
            cols = c("grey85",brewer.pal(9,"YlOrRd")),
             split.by = "orig.ident",label = T,repel = T,
            ncol=2, pt.size = 0.3)
ggsave("./Figure1_scRNA_part/Human_perio_LGR5_split.pdf", device = "pdf", width = 11, height = 5)

```

## Lrig1
```{r,fig.height=6, fig.width=5}
FeaturePlot(JE_combined_epi, features = c("Lrig1"),
            cols = c("grey85",brewer.pal(9,"YlOrRd")),
            label = T,repel = T,
             pt.size = 0.3)
ggsave("./Figure1_scRNA_part/JE_combined_epi_Lrig1.pdf", device = "pdf", width = 6, height = 5)

```
```{r,fig.height=6, fig.width=5}
FeaturePlot(JE_combined, features = c("Lrig1"),
            cols = c("grey85",brewer.pal(9,"YlOrRd")),
            label = T,repel = T,
             pt.size = 0.3)
ggsave("./Figure1_scRNA_part/JE_combined_Lrig1.pdf", device = "pdf", width = 6, height = 5)

```


```{r,fig.height=6, fig.width=16}
FeaturePlot(JE_combined_epi, features = c("Lrig1"),
            cols = c("grey85",brewer.pal(9,"YlOrRd")),
             split.by = "orig.ident",label = T,repel = T,
            ncol=3, pt.size = 0.3)
ggsave("./Figure1_scRNA_part/JE_combined_epi_Lrig1_split.pdf", device = "pdf", width = 16, height = 5)

```
```{r,fig.height=6, fig.width=16}
FeaturePlot(JE_combined, features = c("Lrig1"),
            cols = c("grey85",brewer.pal(9,"YlOrRd")),
             split.by = "orig.ident",label = T,repel = T,
            ncol=3, pt.size = 0.3)
ggsave("./Figure1_scRNA_part/JE_combined_Lrig1_split.pdf", device = "pdf", width = 16, height = 5)

```

```{r, stem cell genes feature plot, fig.height=5, fig.width=6}
library(RColorBrewer)
FeaturePlot(sce.big, features = c("LRIG1"),
            cols = c("grey85",brewer.pal(9,"YlOrRd")),
            label = T,repel = T, pt.size = 0.1)
ggsave("./Figure1_scRNA_part/Human_perio_Lrig1.pdf", device = "pdf", width = 6, height = 5)

```


```{r,fig.height=6, fig.width=11}
FeaturePlot(sce.big, features = c("LRIG1"),
            cols = c("grey85",brewer.pal(9,"YlOrRd")),
             split.by = "orig.ident",label = T,repel = T,
            ncol=2, pt.size = 0.3)
ggsave("./Figure1_scRNA_part/Human_perio_Lrig1_split.pdf", device = "pdf", width = 11, height = 5)

```

## Il24
```{r,fig.height=6, fig.width=5}
FeaturePlot(JE_combined_epi, features = c("Il24"),
            cols = c("grey85",brewer.pal(9,"YlOrRd")),
            label = T,repel = T,
             pt.size = 0.3)
ggsave("./Figure1_scRNA_part/JE_combined_epi_Il24.pdf", device = "pdf", width = 6, height = 5)

```
```{r,fig.height=6, fig.width=5}
FeaturePlot(JE_combined, features = c("Il24"),
            cols = c("grey85",brewer.pal(9,"YlOrRd")),
            label = T,repel = T,
             pt.size = 0.3)
ggsave("./Figure1_scRNA_part/JE_combined_Il24.pdf", device = "pdf", width = 6, height = 5)

```


```{r,fig.height=6, fig.width=16}
FeaturePlot(JE_combined_epi, features = c("Il24"),
            cols = c("grey85",brewer.pal(9,"YlOrRd")),
             split.by = "orig.ident",label = T,repel = T,
            ncol=3, pt.size = 0.3)
ggsave("./Figure1_scRNA_part/JE_combined_epi_Il24_split.pdf", device = "pdf", width = 16, height = 5)

```
```{r,fig.height=6, fig.width=16}
FeaturePlot(JE_combined, features = c("Il24"),
            cols = c("grey85",brewer.pal(9,"YlOrRd")),
             split.by = "orig.ident",label = T,repel = T,
            ncol=3, pt.size = 0.3)
ggsave("./Figure1_scRNA_part/JE_combined_Il24_split.pdf", device = "pdf", width = 16, height = 5)

```

```{r, stem cell genes feature plot, fig.height=5, fig.width=6}
library(RColorBrewer)
FeaturePlot(sce.big, features = c("IL24"),
            cols = c("grey85",brewer.pal(9,"YlOrRd")),
            label = T,repel = T, pt.size = 0.1)
ggsave("./Figure1_scRNA_part/Human_perio_Il24.pdf", device = "pdf", width = 6, height = 5)

```


```{r,fig.height=6, fig.width=11}
FeaturePlot(sce.big, features = c("IL24"),
            cols = c("grey85",brewer.pal(9,"YlOrRd")),
             split.by = "orig.ident",label = T,repel = T,
            ncol=2, pt.size = 0.3)
ggsave("./Figure1_scRNA_part/Human_perio_Il24_split.pdf", device = "pdf", width = 11, height = 5)

```

## 4.3 Human perio

```{r, stem cell genes feature plot, fig.height=4, fig.width=5}
library(RColorBrewer)
FeaturePlot(sce.big, features = c("ODAM"),
            cols = c("grey85",brewer.pal(9,"YlOrRd")),
            label = T,repel = T, pt.size = 0.1)
ggsave("./Figure1_scRNA_part/Human_perio_odam.pdf", device = "pdf", width = 5, height = 4)

```




# X Rdata Save
```{r}

save(JE_combined, #seurat object fro combined with celltype information
     JE_combined_epi, #seurat object for combined_epi with celltype information
     sce.big, #seurat object for human periodontal tissue
     JE_combined_markers, # marker gene list
     JE_combined_epi_markers, # marker gene list for epithelium

     file = "./Figure1_scRNA_part/Figure1_scRNA_part.Rdata")
```
